# åº”ç”¨å¯åŠ¨é—®é¢˜ - ç´§æ€¥ä¿®å¤æŒ‡å—

## é—®é¢˜æè¿°

åº”ç”¨ä¸€ç›´æ˜¾ç¤º"æ„å»ºä¸­"ï¼Œæ— æ³•æ­£å¸¸å¯åŠ¨ã€‚

### é”™è¯¯åŸå› 

æŸ¥çœ‹æ—¥å¿—å‘ç°é”™è¯¯ï¼š
```
. postinstall$ weapp-tw patch
. postinstall: sh: 1: Cannot fork
. postinstall: Failed
```

**æ ¹æœ¬åŸå› ï¼š**
1. `postinstall` è„šæœ¬è¯•å›¾è¿è¡Œ `weapp-tw patch`
2. ç³»ç»Ÿèµ„æºä¸è¶³ï¼Œæ— æ³• fork æ–°è¿›ç¨‹
3. å¯¼è‡´ä¾èµ–å®‰è£…å¤±è´¥
4. åº”ç”¨æ— æ³•å¯åŠ¨

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ä¿®å¤è„šæœ¬ï¼ˆæ¨èï¼‰

æˆ‘å·²ç»åˆ›å»ºäº† `fix-startup.sh` è„šæœ¬ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œï¼š

```bash
chmod +x fix-startup.sh
./fix-startup.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
1. åœæ­¢æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹
2. æ¸…ç†ç¼“å­˜å’Œä¾èµ–
3. é‡æ–°å®‰è£…ä¾èµ–
4. å¯åŠ¨åº”ç”¨

### æ–¹æ¡ˆ 2ï¼šæ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤

å¦‚æœæ— æ³•è¿è¡Œè„šæœ¬ï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

#### æ­¥éª¤ 1ï¼šåœæ­¢è¿›ç¨‹
```bash
pkill -f "pnpm dev"
pkill -f "node.*taro"
pkill -f "coze dev"
```

#### æ­¥éª¤ 2ï¼šæ¸…ç†ç¼“å­˜
```bash
rm -rf node_modules
rm -rf server/node_modules
rm -f pnpm-lock.yaml
```

#### æ­¥éª¤ 3ï¼šé‡æ–°å®‰è£…ä¾èµ–
```bash
pnpm install
```

å¦‚æœå®‰è£…å¤±è´¥ï¼Œå°è¯•ï¼š
```bash
pnpm install --force
```

#### æ­¥éª¤ 4ï¼šå¯åŠ¨åº”ç”¨
```bash
cd /workspace/projects
pnpm dev
```

### æ–¹æ¡ˆ 3ï¼šè·³è¿‡ postinstallï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

å¦‚æœä¸Šè¿°æ–¹æ¡ˆéƒ½ä¸è¡Œï¼Œå¯ä»¥è·³è¿‡ postinstall è„šæœ¬ï¼š

#### åˆ›å»º .npmrc æ–‡ä»¶
```bash
cat > .npmrc << 'EOF'
shamefully-hoist=true
strict-peer-dependencies=false
ignore-scripts=false
EOF
```

#### é‡æ–°å®‰è£…
```bash
rm -rf node_modules pnpm-lock.yaml
pnpm install --no-frozen-lockfile
```

## éªŒè¯ä¿®å¤

### æ£€æŸ¥åº”ç”¨æ˜¯å¦å¯åŠ¨æˆåŠŸ

#### æ–¹æ³• 1ï¼šæ£€æŸ¥ç«¯å£
```bash
# æ£€æŸ¥ H5 ç«¯å£
curl -I http://localhost:5000

# æ£€æŸ¥åç«¯ç«¯å£
curl -I http://localhost:3000
```

é¢„æœŸè¾“å‡ºï¼š
```
HTTP/1.1 200 OK
...
```

#### æ–¹æ³• 2ï¼šæŸ¥çœ‹æ—¥å¿—
```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f /tmp/coze-logs/dev.log

# æŸ¥çœ‹æœ€è¿‘ 50 è¡Œ
tail -50 /tmp/coze-logs/dev.log
```

#### æ–¹æ³• 3ï¼šæµè§ˆå™¨è®¿é—®
- H5 ç«¯ï¼šhttp://localhost:5000
- åç«¯ APIï¼šhttp://localhost:3000

### æˆåŠŸçš„æ ‡å¿—

çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºè¡¨ç¤ºå¯åŠ¨æˆåŠŸï¼š
```
[web] ğŸ‘½ Taro v4.1.9
[web] Starting development server...
[web] Local: http://localhost:5000
[server] [Nest] Successfully started
[server] Application successfully started
```

## å¦‚æœé—®é¢˜ä¾ç„¶å­˜åœ¨

### æ£€æŸ¥ç³»ç»Ÿèµ„æº
```bash
# æ£€æŸ¥å†…å­˜ä½¿ç”¨
free -h

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ£€æŸ¥è¿›ç¨‹æ•°
ps aux | wc -l
```

### æ¸…ç†ç³»ç»Ÿèµ„æº
```bash
# æ¸…ç† npm ç¼“å­˜
pnpm store prune

# æ¸…ç† Docker å®¹å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
docker system prune -a

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -rf /tmp/*
```

### é‡å¯æœåŠ¡
```bash
# å®Œå…¨é‡å¯
cd /workspace/projects
pkill -9 -f node
pnpm install --force
pnpm dev
```

## è”ç³»æ”¯æŒ

å¦‚æœä¸Šè¿°æ–¹æ³•éƒ½æ— æ³•è§£å†³é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. ç³»ç»Ÿèµ„æºä¿¡æ¯ï¼š
   ```bash
   free -h
   df -h
   ps aux | wc -l
   ```

2. æ—¥å¿—å†…å®¹ï¼š
   ```bash
   tail -100 /tmp/coze-logs/dev.log
   tail -100 /app/work/logs/bypass/dev.log
   ```

3. é”™è¯¯ä¿¡æ¯ï¼š
   ```bash
   pnpm install 2>&1 | tee install.log
   ```

## é¢„é˜²æªæ–½

ä¸ºäº†é¿å…ç±»ä¼¼é—®é¢˜ï¼Œå»ºè®®ï¼š

1. **å®šæœŸæ¸…ç†ä¾èµ–**
   ```bash
   pnpm store prune
   rm -rf node_modules
   pnpm install
   ```

2. **ä½¿ç”¨å›ºå®šçš„ lockfile**
   ```bash
   pnpm install --frozen-lockfile
   ```

3. **ç›‘æ§ç³»ç»Ÿèµ„æº**
   - å®šæœŸæ£€æŸ¥å†…å­˜ä½¿ç”¨
   - æ¸…ç†ä¸å¿…è¦çš„è¿›ç¨‹

4. **ä¼˜åŒ– postinstall**
   - å·²ç»ä¿®æ”¹ `package.json`ï¼Œè·³è¿‡ `weapp-tw patch`
   - å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨ç³»ç»Ÿèµ„æºå……è¶³æ—¶æ‰‹åŠ¨è¿è¡Œ

## å¿«é€Ÿå‚è€ƒ

### ä¸€é”®ä¿®å¤
```bash
chmod +x fix-startup.sh && ./fix-startup.sh
```

### æ‰‹åŠ¨ä¿®å¤
```bash
pkill -f "pnpm dev"
rm -rf node_modules server/node_modules pnpm-lock.yaml
pnpm install --force
cd /workspace/projects && pnpm dev
```

### æ£€æŸ¥çŠ¶æ€
```bash
curl -I http://localhost:5000
tail -50 /tmp/coze-logs/dev.log
```

---

**æœ€åæ›´æ–°ï¼š** 2025-01-XX
**çŠ¶æ€ï¼š** ç­‰å¾…ç³»ç»Ÿæ¢å¤åæ‰§è¡Œ
