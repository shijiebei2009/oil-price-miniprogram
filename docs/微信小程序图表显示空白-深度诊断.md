# 微信小程序图表显示空白 - 深度诊断

## 问题描述

在 iPhone 手机上，微信扫码体验时，历史价格页面的走势图显示空白。

## 已完成的修复

### 1. Canvas 尺寸问题修复

**问题**：Canvas 组件没有明确的 width 和 height 属性，导致查询到的尺寸为 0。

**修复**：
- 为 Canvas 组件添加内联样式 `style="width: 100%; height: 100%;"`
- 为 WxChart 容器添加明确的宽度和高度设置
- 使用 CSS 变量动态传递高度值

**文件**：
- `src/components/ec-canvas/index.wxml`
- `src/components/WxChart/index.css`
- `src/components/WxChart/index.tsx`

### 2. 初始化时机优化

**问题**：Canvas 初始化时，父容器可能还未完全渲染，导致获取到的尺寸为 0。

**修复**：
- 在 `ec-canvas` 组件的 `ready` 生命周期中延迟 200ms 后再初始化 Canvas
- 确保父容器已经渲染完成

**文件**：
- `src/components/ec-canvas/index.js`

### 3. Canvas ID 优化

**问题**：每次渲染都生成新的 canvasId，可能导致 Canvas 节点查找失败。

**修复**：
- 使用固定的 canvasId `price-chart-canvas-main`
- 确保在整个应用中唯一

**文件**：
- `src/components/PriceChart/index.tsx`

### 4. 调试日志增强

**修复**：
- 添加详细的调试日志，包括：
  - ec-canvas 初始化流程日志
  - Canvas 节点查询结果
  - Canvas 尺寸信息
  - ECharts 实例创建过程

**文件**：
- `src/components/ec-canvas/index.js`
- `src/components/WxChart/index.tsx`

## 诊断步骤

### Step 1：查看控制台日志

在微信开发者工具或真机调试模式下，打开控制台，查看以下关键日志：

```
ec-canvas: ready 生命周期触发
ec-canvas: canvasId price-chart-canvas-main
ec-canvas: 开始初始化
ec-canvas: 初始化
initNewCanvas: 查询结果
initNewCanvas: canvas 节点获取成功
initNewCanvas: canvas 尺寸 { width: xxx, height: xxx }
initNewCanvas: 调用 onInit 回调
WxChart: 初始化图表
WxChart: ECharts 实例创建成功
```

**检查要点**：
- ✅ 是否看到所有日志输出
- ✅ Canvas 尺寸是否为 0（如果为 0，说明父容器尺寸不正确）
- ✅ ECharts 实例是否成功创建

### Step 2：检查 Canvas 节点

在微信开发者工具中，使用调试器检查 Canvas 节点：

1. 打开调试器
2. 切换到 "Elements" 或 "WXML" 标签
3. 查找 canvas 节点（id="price-chart-canvas-main"）
4. 检查节点的以下属性：
   - `id`：应该是 "price-chart-canvas-main"
   - `canvas-id`：应该是 "price-chart-canvas-main"
   - `width`：应该大于 0（如 343）
   - `height`：应该大于 0（如 300）

### Step 3：检查父容器尺寸

检查以下容器的尺寸是否正确：

1. **PriceChart 容器**（`.price-chart`）
   - 应该有明确的 `width: 100%`
   - 应该有 `padding: 16px`

2. **图表容器**（`.chart-container`）
   - 应该有明确的 `width: 100%`
   - 应该有 `min-height: 300px`
   - 应该有 `box-sizing: border-box`

3. **WxChart 容器**（`.wx-chart-container`）
   - 应该有明确的 `width: 100%`
   - 应该有 `height: var(--chart-height, 300px)`
   - 应该有 `position: relative`

### Step 4：检查图表数据

确认图表数据是否正确加载：

1. 在控制台中查找以下日志：
   ```
   开始获取历史价格数据，天数: 7
   历史价格数据响应: {...}
   历史价格数据解析成功: [...]
   渲染走势图，数据长度: 7
   ```

2. 检查数据格式是否正确：
   - `data` 数组长度是否大于 0
   - 每个数据项是否包含 `date`, `gas92`, `gas95`, `gas98`, `diesel0` 字段
   - 价格数值是否为有效的数字

### Step 5：检查 ECharts 配置

确认 ECharts 配置是否正确：

1. 在控制台中查找以下日志：
   ```
   WxChart: 初始化图表
   WxChart: option 更新
   WxChart: 更新图表选项
   ```

2. 检查 option 配置是否包含：
   - `xAxis.type: 'category'`
   - `yAxis.type: 'value'`
   - `series` 数组包含至少一个系列
   - `series[0].data` 数组长度大于 0

## 常见问题及解决方案

### 问题 1：Canvas 尺寸为 0

**症状**：
```
initNewCanvas: canvas 尺寸 { width: 0, height: 0 }
initNewCanvas: Canvas 尺寸为 0！无法初始化图表
```

**可能原因**：
1. 父容器尺寸不正确
2. CSS 样式未生效
3. 容器使用了 `display: none` 或 `visibility: hidden`

**解决方案**：
1. 检查父容器的 `width` 和 `height` 是否明确设置
2. 检查 CSS 是否正确编译和应用
3. 确保容器不是隐藏状态

### 问题 2：Canvas 节点未找到

**症状**：
```
initNewCanvas: 未找到 canvas 节点，canvasId: price-chart-canvas-main
```

**可能原因**：
1. canvasId 不匹配
2. Canvas 组件未正确渲染
3. ec-canvas 组件未正确注册

**解决方案**：
1. 确认 WxChart 和 ec-canvas 的 canvasId 一致
2. 检查 Canvas 组件是否在 WXML 中正确渲染
3. 确认 ec-canvas 组件在 `app.config.ts` 中已正确注册

### 问题 3：ECharts 实例创建失败

**症状**：
```
WxChart: 图表初始化失败
```

**可能原因**：
1. ECharts 配置错误
2. 数据格式不正确
3. Canvas 上下文获取失败

**解决方案**：
1. 检查 ECharts option 配置是否正确
2. 确认数据格式符合 ECharts 要求
3. 检查 Canvas 上下文是否成功获取

### 问题 4：图表显示但数据不正确

**症状**：
- Canvas 正常显示，但图表内容不正确
- 只有坐标轴，没有数据线
- 数据线显示不完整

**可能原因**：
1. 数据格式错误
2. 图表配置错误
3. 数据范围不正确

**解决方案**：
1. 检查数据格式是否正确（dates 数组、prices 数组）
2. 确认图表配置是否包含所有必需字段
3. 调整数据范围或图表配置

## 调试技巧

### 1. 使用 console.log 调试

在关键位置添加 console.log，输出重要信息：

```javascript
console.log('Canvas 尺寸:', { width, height })
console.log('图表数据:', data)
console.log('ECharts 配置:', option)
```

### 2. 使用调试器检查 DOM

在微信开发者工具中，使用调试器检查：
- Canvas 节点是否存在
- Canvas 节点的尺寸是否正确
- 父容器的尺寸是否正确

### 3. 使用真机调试

在真机上启用调试模式，查看真机上的日志：

1. 在微信开发者工具中，点击 "真机调试"
2. 扫码进入真机调试模式
3. 在真机上操作，查看控制台日志

### 4. 逐步排查

如果问题仍然存在，可以按照以下步骤逐步排查：

1. **最小化复现**：创建一个最简单的 Canvas 示例，确认 Canvas 是否能正常显示
2. **逐步添加功能**：逐步添加 ECharts 功能，确定哪个环节出现问题
3. **对比测试**：在 H5 端和微信小程序端分别测试，确认是否是平台特定问题

## 参考资源

- [微信小程序 Canvas 文档](https://developers.weixin.qq.com/miniprogram/dev/api/canvas/wx.createCanvasContext.html)
- [ECharts For Weixin](https://github.com/ecomfe/echarts-for-weixin)
- [Taro Canvas 文档](https://docs.taro.zone/docs/components/canvas)

## 下一步行动

如果以上步骤都无法解决问题，请提供以下信息：

1. **控制台日志**：完整的控制台日志输出
2. **Canvas 节点信息**：Canvas 节点的属性和尺寸
3. **图表数据**：传递给 ECharts 的数据
4. **设备信息**：iPhone 型号、微信版本、小程序基础库版本

---

**最后更新**：2026-02-26
**维护者**：AI 助手
