# 微信小程序图表显示问题修复

## 问题描述

微信扫码体验时，历史价格页面的走势图无法显示。

## 根本原因分析

### 1. Canvas ID 冲突

**问题**：WxChart 组件使用固定的 canvasId `mychart-canvas`，导致多个实例之间可能产生冲突。

**影响**：可能导致 canvas 节点无法正确查找，图表初始化失败。

**修复**：使用动态生成的唯一 canvasId。

```tsx
// 修复前
canvasId="mychart-canvas"

// 修复后
canvasId={`price-chart-canvas-${Date.now()}`}
```

### 2. ec-canvas 组件 ID 不匹配

**问题**：WxChart 组件传递给 ec-canvas 的 `id` 和 `canvas-id` 不一致。

- WxChart 传递的 `id`：`mychart-dom-${canvasId}`
- ec-canvas 查询的 `id`：`${canvasId}`

**影响**：ec-canvas 组件无法找到正确的 canvas 节点。

**修复**：统一使用相同的 ID。

```tsx
// 修复前
<ec-canvas
  id={`mychart-dom-${canvasId}`}
  canvas-id={canvasId}
  ...
/>

// 修复后
<ec-canvas
  id={canvasId}
  canvas-id={canvasId}
  ...
/>
```

### 3. Canvas 组件缺少 id 属性

**问题**：ec-canvas 的 wxml 文件中，canvas 组件没有指定 `id` 属性，只有 `canvas-id`。

**影响**：使用新版 Canvas（type="2d"）时，需要通过 id 查找节点，可能导致查询失败。

**修复**：为 canvas 组件添加 `id` 属性。

```html
<!-- 修复前 -->
<canvas wx:if="{{isUseNewCanvas}}" type="2d" class="ec-canvas" canvas-id="{{ canvasId }}" ...></canvas>

<!-- 修复后 -->
<canvas wx:if="{{isUseNewCanvas}}" type="2d" id="{{ canvasId }}" class="ec-canvas" canvas-id="{{ canvasId }}" ...></canvas>
```

### 4. 缺少调试信息

**问题**：ec-canvas 组件初始化失败时，没有足够的日志信息来诊断问题。

**影响**：难以定位问题根源。

**修复**：添加详细的调试日志。

```javascript
// 添加的调试日志
console.log('initNewCanvas: 查询结果', res)
console.log('initNewCanvas: canvas 节点获取成功')
console.log('initNewCanvas: canvas 尺寸', { width: canvasWidth, height: canvasHeight })
console.log('initNewCanvas: 设备像素比', dpr)
console.log('initNewCanvas: canvas 尺寸已调整')
console.log('initNewCanvas: 调用 onInit 回调')
```

## 修复内容

### 1. WxChart 组件修复

**文件**：`src/components/WxChart/index.tsx`

**修改**：
- 统一 ec-canvas 组件的 `id` 和 `canvas-id`
- 添加 option 更新日志
- 添加 notMerge 参数到 setOption 调用
- 为 View 容器添加 position: relative

### 2. PriceChart 组件修复

**文件**：`src/components/PriceChart/index.tsx`

**修改**：
- 使用动态生成的唯一 canvasId
- 避免多个实例之间的 ID 冲突

### 3. ec-canvas 组件修复

**文件**：`src/components/ec-canvas/index.js`

**修改**：
- 添加详细的调试日志
- 修复 initOldCanvas 方法的错误处理
- 添加 wx.createCanvasContext 存在性检查

**文件**：`src/components/ec-canvas/index.wxml`

**修改**：
- 为 canvas 组件添加 `id` 属性
- 移除不存在的 `bindinit` 事件

## 测试建议

### 1. 查看控制台日志

在微信开发者工具中，打开控制台，查看以下日志：

```
WxChart: 初始化图表
initNewCanvas: 查询结果
initNewCanvas: canvas 节点获取成功
initNewCanvas: canvas 尺寸
initNewCanvas: 设备像素比
initNewCanvas: canvas 尺寸已调整
initNewCanvas: 调用 onInit 回调
WxChart: ECharts 实例创建成功
```

### 2. 检查 Canvas 节点

在微信开发者工具中，使用调试器检查 Canvas 节点：

1. 打开调试器
2. 切换到 "Elements" 或 "WXML" 标签
3. 查找 canvas 节点
4. 检查节点的 id 和 canvas-id 属性是否一致

### 3. 检查图表配置

确认图表配置是否正确：

- 确保数据格式正确（dates 数组、prices 数组）
- 确保图表配置包含所有必需的字段
- 确保图表尺寸正确（width 和 height）

### 4. 测试不同场景

- 测试加载不同时间范围的数据（7天、30天、90天、180天）
- 测试切换时间范围时的图表更新
- 测试图表导出功能

## 常见问题排查

### 问题 1：图表不显示

**可能原因**：
- Canvas ID 冲突
- Canvas 节点未找到
- 图表配置错误

**排查步骤**：
1. 查看控制台日志，确认是否有错误
2. 检查 Canvas 节点是否正确创建
3. 检查图表配置是否正确

### 问题 2：图表显示但数据不正确

**可能原因**：
- 数据格式错误
- 图表配置错误
- 数据更新未触发

**排查步骤**：
1. 检查数据格式是否正确
2. 检查图表配置是否正确
3. 查看控制台日志，确认图表是否重新渲染

### 问题 3：图表导出失败

**可能原因**：
- Canvas 节点未找到
- 权限问题
- 导出方法调用错误

**排查步骤**：
1. 查看控制台日志，确认是否有错误
2. 检查是否已授予相册权限
3. 检查导出方法调用是否正确

## 技术细节

### Canvas 版本检测

ec-canvas 组件会自动检测微信小程序的版本，选择合适的 Canvas 实现：

- **新版 Canvas**（SDKVersion >= 2.9.0）：使用 type="2d"
- **旧版 Canvas**（SDKVersion < 2.9.0）：使用旧版 API

### 设备像素比处理

新版 Canvas 会根据设备像素比（DPR）调整 Canvas 的实际尺寸：

```javascript
const dpr = wx.getSystemInfoSync().pixelRatio
canvas.width = canvasWidth * dpr
canvas.height = canvasHeight * dpr
ctx.scale(dpr, dpr)
```

### Canvas 节点查询

使用微信小程序的 `createSelectorQuery` API 查询 Canvas 节点：

```javascript
const query = wx.createSelectorQuery().in(this)
query
  .select(`#${canvasId}`)
  .fields({ node: true, size: true })
  .exec((res) => {
    // 处理查询结果
  })
```

## 参考资料

- [微信小程序 Canvas 文档](https://developers.weixin.qq.com/miniprogram/dev/api/canvas/wx.createCanvasContext.html)
- [ECharts For Weixin](https://github.com/ecomfe/echarts-for-weixin)
- [Taro Canvas 文档](https://docs.taro.zone/docs/components/canvas)

## 总结

通过以上修复，微信小程序端的图表显示问题应该得到解决。主要修复包括：

1. ✅ 修复 Canvas ID 冲突
2. ✅ 统一 ec-canvas 的 id 和 canvas-id
3. ✅ 为 Canvas 组件添加 id 属性
4. ✅ 添加详细的调试日志

如果问题仍然存在，请查看控制台日志，并根据日志信息进一步排查。

---

**最后更新**：2026-02-26
**维护者**：AI 助手
