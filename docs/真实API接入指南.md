# 真实 API 数据接入指南

## 概述

本小程序支持使用真实的油价 API 数据，而非基于公开数据的计算。我们支持以下两个 API 服务商：

1. **天行数据**（推荐 ⭐⭐⭐⭐⭐）
2. **聚合数据**（备选）

---

## 方案一：天行数据（推荐）

### 优势

- ✅ 有免费额度：每分钟3次调用
- ✅ 数据实时更新
- ✅ API文档清晰
- ✅ 支持全国所有城市
- ✅ 数据准确性高

### 注册步骤

#### 1. 注册账号
1. 访问天行数据官网：https://www.tianapi.com/
2. 点击右上角"注册"
3. 使用手机号或邮箱注册
4. 完成手机验证

#### 2. 申请 API
1. 登录后，点击顶部"控制台"
2. 在"API接口"中搜索"油价"
3. 找到"全国油价查询"接口
4. 点击"申请接入"
5. 选择免费套餐（每分钟3次）

#### 3. 获取 API Key
1. 在控制台"我的接口"中
2. 找到"全国油价查询"
3. 复制您的 API Key（格式如：`a1b2c3d4e5f6g7h8i9j0`）

### 配置方法

在项目根目录创建 `.env` 文件：

```bash
TIANAPI_KEY=你的API_Key
```

### API 接口说明

**接口地址**：
```
http://api.tianapi.com/oilprice/index
```

**请求参数**：

| 参数名 | 必填 | 类型 | 说明 |
|--------|------|------|------|
| key | 是 | string | API Key |
| city | 否 | string | 城市名称，不传则返回全国列表 |

**请求示例**：

```bash
# 查询全国油价
curl "http://api.tianapi.com/oilprice/index?key=你的API_Key"

# 查询指定城市
curl "http://api.tianapi.com/oilprice/index?key=你的API_Key&city=北京"
```

**响应示例**：

```json
{
  "code": 200,
  "msg": "success",
  "result": {
    "updatetime": "2026-02-26",
    "city": "北京",
    "p92": 7.97,
    "p95": 8.48,
    "p98": 9.50,
    "p0": 7.59
  }
}
```

**响应字段说明**：

| 字段 | 说明 |
|------|------|
| updatetime | 更新时间 |
| city | 城市名称 |
| p92 | 92号汽油价格（元/升） |
| p95 | 95号汽油价格（元/升） |
| p98 | 98号汽油价格（元/升） |
| p0 | 0号柴油价格（元/升） |

### 使用限制

- 免费版：每分钟3次调用
- 付费版：根据套餐提升频率

### 测试

配置完成后，重启服务，然后测试：

```bash
curl "http://api.tianapi.com/oilprice/index?key=你的API_Key"
```

返回 `code: 200` 表示成功！

---

## 方案二：聚合数据（Juhe）

### 优势

- ✅ 老牌服务商，稳定可靠
- ✅ 有免费额度
- ✅ 数据准确
- ✅ 按省份返回数据

### 注册步骤

#### 1. 注册账号
1. 访问聚合数据官网：https://www.juhe.cn/
2. 点击右上角"注册"
3. 使用手机号注册
4. 完成验证

#### 2. 申请 API
1. 登录后，进入"数据中心"
2. 搜索"油价"或"汽柴油"
3. 找到"全国汽油柴油实时价格查询"
4. 点击"申请"
5. 选择免费套餐（100次/天）

#### 3. 获取 API Key
1. 在"我的API"中
2. 找到"全国汽油柴油实时价格查询"
3. 复制 Request Key

### 配置方法

在项目根目录的 `.env` 文件中添加：

```bash
JUHE_API_KEY=你的API_Key
```

### API 接口说明

**接口地址**：
```
http://web.juhe.cn:8080/finance/oil/goldprice
```

**请求参数**：

| 参数名 | 必填 | 类型 | 说明 |
|--------|------|------|------|
| key | 是 | string | API Key |
| prov | 否 | string | 省份名称，不传则返回全国 |

**请求示例**：

```bash
# 查询全国油价
curl "http://web.juhe.cn:8080/finance/oil/goldprice?key=你的API_Key"

# 查询指定省份
curl "http://web.juhe.cn:8080/finance/oil/goldprice?key=你的API_Key&prov=北京"
```

**响应示例**：

```json
{
  "error_code": 0,
  "reason": "success",
  "result": [
    {
      "prov": "北京",
      "p92": "7.97",
      "p95": "8.48",
      "p98": "9.50",
      "p0": "7.59",
      "updatetime": "2026-02-26"
    }
  ]
}
```

### 使用限制

- 免费版：100次/天
- 付费版：购买次数包

### 测试

配置完成后，重启服务，然后测试：

```bash
curl "http://web.juhe.cn:8080/finance/oil/goldprice?key=你的API_Key"
```

返回 `error_code: 0` 表示成功！

---

## 数据优先级

系统会按照以下顺序尝试获取数据：

1. **天行数据 API**（如果配置了 `TIANAPI_KEY`）
2. **聚合数据 API**（如果天行数据不可用，且配置了 `JUHE_API_KEY`）
3. **备选数据源**（基于国家发改委数据的计算）

---

## 配置步骤总结

### 方法一：使用天行数据（推荐）

1. 在 [天行数据](https://www.tianapi.com/) 注册账号
2. 申请"全国油价查询"API
3. 复制 API Key
4. 在项目根目录创建 `.env` 文件：

```bash
TIANAPI_KEY=你的API_Key
```

5. 重启服务：

```bash
cd /workspace/projects
coze dev
```

### 方法二：使用聚合数据

1. 在 [聚合数据](https://www.juhe.cn/) 注册账号
2. 申请"全国汽油柴油实时价格查询"API
3. 复制 API Key
4. 在项目根目录的 `.env` 文件中添加：

```bash
JUHE_API_KEY=你的API_Key
```

5. 重启服务

---

## 验证配置成功

配置完成后，查看服务日志：

```bash
tail -100 /tmp/coze-logs/dev.log | grep -E "天行数据|聚合数据"
```

如果看到以下日志，说明配置成功：

```
[Nest] [OilPriceService] 使用天行数据 API 获取油价...
[Nest] [OilPriceService] ✅ 天行数据 API 油价数据获取成功
```

或

```
[Nest] [OilPriceService] 使用聚合数据 API 获取油价...
[Nest] [OilPriceService] ✅ 聚合数据 API 油价数据获取成功
```

---

## 常见问题

### 1. 为什么不使用真实数据？

**回答**：如果未配置 API Key，系统会使用备选数据源（基于国家发改委数据的计算）。要使用真实数据，必须配置上述任一 API Key。

### 2. 两个 API 都配置了会怎样？

**回答**：系统会优先使用天行数据，如果天行数据失败，会尝试聚合数据。

### 3. API 调用次数超限了怎么办？

**回答**：
- 天行数据：升级套餐或等待下一分钟
- 聚合数据：购买次数包或等待第二天

### 4. 数据多久更新一次？

**回答**：
- API 数据：由服务商更新，通常每天更新
- 本地缓存：24小时后自动刷新

### 5. 如何查看当前使用的数据源？

**回答**：查看服务日志，会显示使用的是哪个数据源。

---

## 费用对比

| 服务商 | 免费额度 | 付费价格 | 推荐指数 |
|--------|----------|----------|----------|
| 天行数据 | 3次/分钟 | ¥49/月起 | ⭐⭐⭐⭐⭐ |
| 聚合数据 | 100次/天 | ¥0.005/次起 | ⭐⭐⭐⭐ |

---

## 推荐方案

**强烈推荐使用天行数据**：

1. 免费额度更合理（每分钟3次，可满足小程序日常使用）
2. 数据更新及时
3. API 文档清晰
4. 支持全国所有城市

---

## 技术支持

如有问题，请参考：
- 天行数据文档：https://www.tianapi.com/apiview/196
- 聚合数据文档：https://www.juhe.cn/docs/api/id/86

---

## 下一步

1. 选择一个 API 服务商并注册
2. 申请 API Key
3. 配置到 `.env` 文件
4. 重启服务
5. 验证数据来源

享受真实的油价数据！🎉
